<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Bay Ridge Citi Bike â€” Neighborhood Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=IBM+Plex+Mono:wght@400;600&family=IBM+Plex+Sans:wght@300;400;500;600&display=swap" rel="stylesheet"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"/>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --ink:#0f1117;
  --ink2:#3a3f52;
  --muted:#8b92a8;
  --rule:#dde1ea;
  --bg:#f5f4f0;
  --surface:#ffffff;
  --accent:#0057b8;
  --accent-light:#e8f0fb;
  --accent2:#e8383b;
  --accent2-light:#fdeaea;
  --green:#00875a;
  --green-light:#e3f5ef;
  --amber:#c47c00;
  --amber-light:#fef3dc;
  --font-display:'Playfair Display',Georgia,serif;
  --font-mono:'IBM Plex Mono',monospace;
  --font-body:'IBM Plex Sans',system-ui,sans-serif;
}
body{background:var(--bg);color:var(--ink);font-family:var(--font-body);min-height:100vh;overflow-x:hidden}

/* â”€â”€ MASTHEAD â”€â”€ */
.masthead{
  background:var(--surface);
  border-bottom:3px solid var(--ink);
  padding:0 40px;
}
.masthead-top{
  display:flex;align-items:center;justify-content:space-between;
  padding:20px 0 16px;
  border-bottom:1px solid var(--rule);
}
.masthead-title{
  font-family:var(--font-display);
  font-size:28px;font-weight:900;
  letter-spacing:-0.02em;
  line-height:1;
}
.masthead-title span{color:var(--accent)}
.masthead-eyebrow{
  font-family:var(--font-mono);
  font-size:10px;letter-spacing:0.12em;
  text-transform:uppercase;color:var(--muted);
  margin-bottom:6px;
}
.masthead-right{display:flex;align-items:center;gap:20px}
.live-pill{
  display:flex;align-items:center;gap:7px;
  background:var(--green-light);border:1px solid var(--green);
  border-radius:3px;padding:5px 12px;
  font-family:var(--font-mono);font-size:11px;color:var(--green);font-weight:600;
}
.live-dot{width:7px;height:7px;border-radius:50%;background:var(--green);animation:blink 2s infinite}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}
.updated-text{font-family:var(--font-mono);font-size:11px;color:var(--muted)}
.refresh-btn{
  font-family:var(--font-mono);font-size:11px;
  background:none;border:1px solid var(--rule);
  border-radius:3px;padding:5px 12px;cursor:pointer;
  color:var(--ink2);transition:all .2s;
}
.refresh-btn:hover{border-color:var(--accent);color:var(--accent)}

/* â”€â”€ NAV TABS â”€â”€ */
.tab-nav{display:flex;gap:0;padding:0}
.tab-btn{
  font-family:var(--font-mono);font-size:12px;font-weight:600;
  letter-spacing:0.04em;text-transform:uppercase;
  padding:14px 28px;cursor:pointer;
  border:none;background:none;color:var(--muted);
  border-bottom:3px solid transparent;margin-bottom:-3px;
  transition:all .2s;position:relative;
}
.tab-btn:hover{color:var(--ink)}
.tab-btn.active{color:var(--accent);border-bottom-color:var(--accent)}

/* â”€â”€ TAB CONTENT â”€â”€ */
.tab-content{display:none}
.tab-content.active{display:block}

/* â”€â”€ CONTAINER â”€â”€ */
.container{max-width:1440px;margin:0 auto;padding:28px 40px}

/* â”€â”€ STAT STRIP â”€â”€ */
.stat-strip{
  display:grid;grid-template-columns:repeat(4,1fr);
  gap:0;border:1px solid var(--rule);
  background:var(--surface);border-radius:4px;
  margin-bottom:24px;overflow:hidden;
}
.stat-block{
  padding:20px 24px;border-right:1px solid var(--rule);
  position:relative;animation:fadeUp .4s ease both;
}
.stat-block:last-child{border-right:none}
.stat-block:nth-child(1){animation-delay:.05s}
.stat-block:nth-child(2){animation-delay:.1s}
.stat-block:nth-child(3){animation-delay:.15s}
.stat-block:nth-child(4){animation-delay:.2s}
@keyframes fadeUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
.stat-block-label{
  font-family:var(--font-mono);font-size:10px;
  letter-spacing:0.1em;text-transform:uppercase;
  color:var(--muted);margin-bottom:8px;
}
.stat-block-value{
  font-family:var(--font-display);font-size:40px;
  font-weight:700;line-height:1;color:var(--accent);
}
.stat-block-value.red{color:var(--accent2)}
.stat-block-value.green{color:var(--green)}
.stat-block-sub{font-size:12px;color:var(--muted);margin-top:6px}
.stat-block-bar{
  position:absolute;bottom:0;left:0;right:0;height:3px;
  background:linear-gradient(90deg,var(--accent),#4da3ff);
  transform:scaleX(0);transform-origin:left;
  transition:transform .8s ease;
}
.stat-block:hover .stat-block-bar{transform:scaleX(1)}

/* â”€â”€ MAIN GRID â”€â”€ */
.main-grid{display:grid;grid-template-columns:380px 1fr;gap:24px}

/* â”€â”€ PANELS â”€â”€ */
.panel{
  background:var(--surface);border:1px solid var(--rule);
  border-radius:4px;overflow:hidden;
}
.panel-head{
  padding:14px 20px;border-bottom:1px solid var(--rule);
  display:flex;align-items:center;justify-content:space-between;
}
.panel-head-title{
  font-family:var(--font-mono);font-size:11px;
  font-weight:600;letter-spacing:0.1em;text-transform:uppercase;
  color:var(--ink2);
}
.panel-head-meta{
  font-family:var(--font-mono);font-size:11px;color:var(--muted);
  background:var(--bg);border-radius:2px;padding:2px 8px;
}

/* â”€â”€ STATION LIST â”€â”€ */
.station-list{overflow-y:auto;max-height:640px}
.station-list::-webkit-scrollbar{width:3px}
.station-list::-webkit-scrollbar-thumb{background:var(--rule)}
.station-item{
  padding:12px 20px;border-bottom:1px solid var(--rule);
  cursor:pointer;transition:background .12s;
}
.station-item:hover{background:var(--bg)}
.station-item.selected{background:var(--accent-light);border-left:3px solid var(--accent)}
.station-item:last-child{border-bottom:none}
.station-item-name{font-size:13px;font-weight:500;margin-bottom:7px;line-height:1.3}
.station-item-name .badge{
  display:inline-block;font-family:var(--font-mono);
  font-size:9px;font-weight:600;letter-spacing:0.06em;
  padding:1px 5px;border-radius:2px;margin-left:6px;
  vertical-align:middle;
}
.badge.original{background:var(--accent-light);color:var(--accent)}
.badge.new{background:var(--amber-light);color:var(--amber)}
.station-bars{display:flex;gap:12px}
.bar-grp{flex:1}
.bar-lbl{display:flex;justify-content:space-between;font-family:var(--font-mono);font-size:10px;color:var(--muted);margin-bottom:3px}
.bar-track{height:4px;background:var(--rule);border-radius:2px;overflow:hidden}
.bar-fill{height:100%;border-radius:2px;transition:width .5s ease}
.bar-fill.bikes{background:var(--accent)}
.bar-fill.bikes.low{background:var(--accent2)}
.bar-fill.docks{background:var(--ink2)}
.station-item-meta{font-family:var(--font-mono);font-size:10px;color:var(--muted);margin-top:6px}
.dot{display:inline-block;width:6px;height:6px;border-radius:50%;margin-right:4px}
.dot.on{background:var(--green)}
.dot.off{background:var(--accent2)}

/* â”€â”€ RIGHT COLUMN â”€â”€ */
.right-col{display:flex;flex-direction:column;gap:20px}

/* â”€â”€ MAP â”€â”€ */
#map-wrap{
  background:var(--surface);border:1px solid var(--rule);
  border-radius:4px;overflow:hidden;height:340px;position:relative;
}
#map{width:100%;height:100%}
.map-label{
  position:absolute;top:12px;left:12px;z-index:500;
  background:rgba(255,255,255,.92);border:1px solid var(--rule);
  border-radius:3px;padding:6px 10px;
  font-family:var(--font-mono);font-size:10px;color:var(--muted);
  backdrop-filter:blur(4px);
}
.map-legend{
  position:absolute;bottom:12px;left:12px;z-index:500;
  background:rgba(255,255,255,.92);border:1px solid var(--rule);
  border-radius:3px;padding:8px 12px;
  font-family:var(--font-mono);font-size:10px;
  backdrop-filter:blur(4px);
  display:flex;flex-direction:column;gap:5px;
}
.legend-item{display:flex;align-items:center;gap:6px;color:var(--ink2)}
.legend-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0}

/* â”€â”€ TIDE CHART â”€â”€ */
.tide-panel{background:var(--surface);border:1px solid var(--rule);border-radius:4px;overflow:hidden}
.tide-inner{padding:20px}
.tide-toggle{display:flex;gap:8px;margin-bottom:16px}
.tide-btn{
  font-family:var(--font-mono);font-size:11px;
  padding:5px 12px;border-radius:2px;cursor:pointer;
  border:1px solid var(--rule);background:none;color:var(--muted);
  transition:all .15s;
}
.tide-btn.active{background:var(--accent);border-color:var(--accent);color:#fff}
.tide-note{font-size:11px;color:var(--muted);font-style:italic;margin-bottom:14px}

/* â”€â”€ DETAIL POPUP â”€â”€ */
.detail-popup{
  display:none;position:fixed;bottom:24px;right:24px;
  width:300px;background:var(--surface);
  border:1px solid var(--ink);border-radius:4px;
  z-index:1000;box-shadow:6px 6px 0 var(--ink);
  animation:popIn .2s ease;
}
@keyframes popIn{from{transform:translateY(16px);opacity:0}to{transform:translateY(0);opacity:1}}
.detail-popup.show{display:block}
.detail-head{padding:12px 16px;border-bottom:1px solid var(--rule);display:flex;justify-content:space-between;align-items:flex-start}
.detail-name{font-weight:600;font-size:13px;flex:1;padding-right:8px;line-height:1.3}
.detail-close{cursor:pointer;font-size:18px;color:var(--muted);transition:color .15s;flex-shrink:0}
.detail-close:hover{color:var(--ink)}
.detail-body{padding:14px 16px}
.detail-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;font-size:13px}
.detail-row-val{font-family:var(--font-mono);font-weight:600}
.detail-cap-track{height:6px;background:var(--rule);border-radius:3px;margin-top:12px;overflow:hidden}
.detail-cap-fill{height:100%;border-radius:3px;background:linear-gradient(90deg,var(--accent),#4da3ff);transition:width .5s}
.detail-cap-lbl{display:flex;justify-content:space-between;font-family:var(--font-mono);font-size:10px;color:var(--muted);margin-top:4px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TAB 2 â€” HISTORICAL & IMPACT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.hist-container{max-width:1440px;margin:0 auto;padding:28px 40px}

/* Section headers â€” editorial style */
.section-head{
  display:flex;align-items:baseline;gap:16px;
  border-bottom:2px solid var(--ink);
  padding-bottom:10px;margin-bottom:24px;
}
.section-number{
  font-family:var(--font-mono);font-size:11px;
  color:var(--muted);letter-spacing:0.08em;
}
.section-title{
  font-family:var(--font-display);font-size:22px;
  font-weight:700;letter-spacing:-0.01em;
}
.section-subtitle{font-size:13px;color:var(--muted);margin-left:auto}

/* â”€â”€ EXPANSION TIMELINE â”€â”€ */
.expansion-section{margin-bottom:48px}
.expansion-lead{
  font-size:15px;line-height:1.7;color:var(--ink2);
  max-width:780px;margin-bottom:28px;
}
.expansion-lead strong{color:var(--ink)}

.timeline-grid{
  display:grid;
  grid-template-columns:repeat(12,1fr);
  gap:3px;margin-bottom:20px;
  align-items:end;
}
.timeline-col{display:flex;flex-direction:column;gap:3px}
.timeline-month-label{
  font-family:var(--font-mono);font-size:9px;
  color:var(--muted);text-align:center;
  margin-top:6px;letter-spacing:0.04em;
}
.timeline-bar{
  border-radius:2px 2px 0 0;
  transition:opacity .2s;cursor:default;
  min-height:4px;
}
.timeline-bar:hover{opacity:.75}
.timeline-bar.original{background:var(--accent)}
.timeline-bar.new{background:var(--amber)}
.timeline-legend{
  display:flex;gap:24px;font-family:var(--font-mono);font-size:11px;color:var(--ink2);
}
.tl-legend-item{display:flex;align-items:center;gap:6px}
.tl-dot{width:10px;height:10px;border-radius:2px;flex-shrink:0}

.expansion-stats{
  display:grid;grid-template-columns:repeat(3,1fr);
  gap:16px;margin-top:24px;
}
.exp-stat{
  background:var(--surface);border:1px solid var(--rule);
  border-radius:4px;padding:20px;
  border-top:3px solid var(--accent);
}
.exp-stat.amber{border-top-color:var(--amber)}
.exp-stat.green{border-top-color:var(--green)}
.exp-stat-val{
  font-family:var(--font-display);font-size:48px;
  font-weight:700;line-height:1;margin-bottom:6px;color:var(--ink);
}
.exp-stat-label{font-size:13px;color:var(--muted);line-height:1.5}

/* â”€â”€ PROOF OF CONCEPT â”€â”€ */
.proof-section{margin-bottom:48px}
.poc-grid{display:grid;grid-template-columns:1fr 1fr;gap:24px}

.poc-chart-wrap{
  background:var(--surface);border:1px solid var(--rule);
  border-radius:4px;padding:24px;
}
.poc-chart-title{
  font-family:var(--font-mono);font-size:11px;
  letter-spacing:0.08em;text-transform:uppercase;
  color:var(--muted);margin-bottom:4px;
}
.poc-chart-headline{
  font-family:var(--font-display);font-size:18px;
  font-weight:700;margin-bottom:16px;color:var(--ink);
}

/* station monthly sparklines */
.sparkline-list{display:flex;flex-direction:column;gap:12px}
.sparkline-row{display:flex;align-items:center;gap:12px}
.sparkline-name{font-size:12px;width:180px;flex-shrink:0;line-height:1.3}
.sparkline-bars{display:flex;gap:2px;align-items:flex-end;flex:1}
.sparkline-bar{
  flex:1;border-radius:1px 1px 0 0;
  background:var(--accent);opacity:.7;
  transition:opacity .15s;cursor:default;
  min-width:4px;
}
.sparkline-bar:hover{opacity:1}
.sparkline-total{font-family:var(--font-mono);font-size:11px;color:var(--muted);width:48px;text-align:right}

/* rhythm chart */
.rhythm-chart-wrap{
  background:var(--surface);border:1px solid var(--rule);
  border-radius:4px;padding:24px;
}

/* â”€â”€ IMPACT SECTION â”€â”€ */
.impact-section{margin-bottom:48px}

.impact-centerpiece{
  background:var(--ink);color:#fff;
  border-radius:4px;padding:48px;
  margin-bottom:24px;
  position:relative;overflow:hidden;
}
.impact-centerpiece::before{
  content:'';position:absolute;
  top:-60px;right:-60px;
  width:300px;height:300px;
  border:40px solid rgba(255,255,255,.04);
  border-radius:50%;
}
.impact-centerpiece::after{
  content:'';position:absolute;
  bottom:-40px;left:200px;
  width:200px;height:200px;
  border:30px solid rgba(255,255,255,.03);
  border-radius:50%;
}
.impact-kicker{
  font-family:var(--font-mono);font-size:11px;
  letter-spacing:0.12em;text-transform:uppercase;
  color:rgba(255,255,255,.5);margin-bottom:20px;
}
.impact-equation{
  display:flex;flex-direction:column;gap:16px;
  margin-bottom:32px;position:relative;z-index:1;
}
.impact-line{
  display:flex;align-items:baseline;gap:16px;
  border-bottom:1px solid rgba(255,255,255,.1);
  padding-bottom:16px;
}
.impact-line:last-child{border-bottom:none;padding-bottom:0}
.impact-num{
  font-family:var(--font-display);font-size:56px;
  font-weight:900;line-height:1;color:#fff;
  flex-shrink:0;min-width:120px;
}
.impact-num.accent{color:#4da3ff}
.impact-num.zero{color:rgba(255,255,255,.2)}
.impact-desc{font-size:15px;color:rgba(255,255,255,.7);line-height:1.5}
.impact-desc strong{color:#fff}

.impact-footnote{
  font-family:var(--font-mono);font-size:11px;
  color:rgba(255,255,255,.4);margin-top:20px;
  position:relative;z-index:1;
  border-top:1px solid rgba(255,255,255,.08);
  padding-top:16px;
}

.impact-secondary{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
.impact-card{
  background:var(--surface);border:1px solid var(--rule);
  border-radius:4px;padding:20px;
}
.impact-card-icon{font-size:24px;margin-bottom:10px}
.impact-card-val{
  font-family:var(--font-display);font-size:32px;
  font-weight:700;color:var(--accent);margin-bottom:4px;
}
.impact-card-label{font-size:13px;color:var(--muted);line-height:1.5}

/* â”€â”€ DESTINATIONS â”€â”€ */
.dest-section{margin-bottom:48px}
.dest-grid{display:grid;grid-template-columns:1fr 1fr;gap:24px}
.dest-list{background:var(--surface);border:1px solid var(--rule);border-radius:4px;overflow:hidden}
.dest-item{
  display:flex;align-items:center;gap:12px;
  padding:10px 16px;border-bottom:1px solid var(--rule);
  font-size:13px;
}
.dest-item:last-child{border-bottom:none}
.dest-rank{
  font-family:var(--font-mono);font-size:11px;
  color:var(--muted);width:20px;flex-shrink:0;
}
.dest-name{flex:1;color:var(--ink2)}
.dest-count{font-family:var(--font-mono);font-size:12px;color:var(--ink);font-weight:600}
.dest-bar-wrap{width:80px;flex-shrink:0}
.dest-bar{height:4px;background:var(--accent);border-radius:2px}

/* â”€â”€ LOADING / ERROR â”€â”€ */
.load-state{
  display:flex;flex-direction:column;align-items:center;
  justify-content:center;padding:60px 20px;gap:12px;
  color:var(--muted);font-family:var(--font-mono);font-size:12px;
}
.spinner{
  width:24px;height:24px;border:2px solid var(--rule);
  border-top-color:var(--accent);border-radius:50%;
  animation:spin .8s linear infinite;
}
@keyframes spin{to{transform:rotate(360deg)}}

/* â”€â”€ ACTIVITY FEED â”€â”€ */
.activity-grid{display:grid;grid-template-columns:1fr 1fr}
.activity-col{padding:16px 20px}
.activity-col:first-child{border-right:1px solid var(--rule)}
.activity-col-title{font-family:var(--font-mono);font-size:10px;letter-spacing:0.1em;text-transform:uppercase;color:var(--muted);margin-bottom:12px}
.activity-item{display:flex;align-items:center;gap:10px;padding:6px 0;border-bottom:1px solid var(--rule);font-size:12px}
.activity-item:last-child{border-bottom:none}
.activity-icon{font-size:14px;flex-shrink:0}
.activity-station{flex:1;color:var(--ink2);line-height:1.3}
.activity-count{font-family:var(--font-mono);font-size:13px;font-weight:600;flex-shrink:0}
.activity-count.dep{color:var(--accent2)}
.activity-count.arr{color:var(--green)}
.activity-empty{padding:20px;text-align:center;font-family:var(--font-mono);font-size:11px;color:var(--muted)}
.network-health{display:flex;align-items:center;gap:16px;padding:12px 20px;border-top:1px solid var(--rule);background:var(--bg);font-size:12px;color:var(--ink2)}
.health-badge{font-family:var(--font-mono);font-size:11px;font-weight:600;padding:4px 10px;border-radius:2px}
.health-badge.healthy{background:var(--green-light);color:var(--green)}
.health-badge.moderate{background:var(--amber-light);color:var(--amber)}
.health-badge.busy{background:var(--accent2-light);color:var(--accent2)}
/* responsive */
@media(max-width:960px){
  .main-grid{grid-template-columns:1fr}
  .poc-grid{grid-template-columns:1fr}
  .impact-secondary{grid-template-columns:1fr}
  .expansion-stats{grid-template-columns:1fr 1fr}
  .container,.hist-container{padding:20px}
  .masthead{padding:0 20px}
  .impact-num{font-size:36px}
}
</style>
</head>
<body>

<!-- â”€â”€ MASTHEAD â”€â”€ -->
<header class="masthead">
  <div class="masthead-top">
    <div>
      <div class="masthead-eyebrow">Bay Ridge, Brooklyn Â· Neighborhood Data</div>
      <div class="masthead-title">ğŸš² Bay Ridge <span>Citi Bike</span></div>
    </div>
    <div class="masthead-right">
      <div class="live-pill"><div class="live-dot"></div>LIVE</div>
      <span class="updated-text" id="lastUpdated">â€”</span>
      <button class="refresh-btn" onclick="fetchLiveData()">â†» Refresh</button>
    </div>
  </div>
  <nav class="tab-nav">
    <button class="tab-btn active" onclick="switchTab('live')" id="tab-live">Live Utilization</button>
    <button class="tab-btn" onclick="switchTab('hist')" id="tab-hist">Historical &amp; Impact</button>
  </nav>
</header>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     TAB 1 â€” LIVE UTILIZATION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="tab-content active" id="content-live">
<div class="container">

  <!-- Stat Strip -->
  <div class="stat-strip" style="grid-template-columns:repeat(6,1fr)">
    <div class="stat-block">
      <div class="stat-block-label">Stations Online</div>
      <div class="stat-block-value" id="s-stations">â€”</div>
      <div class="stat-block-sub">Bay Ridge network</div>
      <div class="stat-block-bar"></div>
    </div>
    <div class="stat-block">
      <div class="stat-block-label">Bikes Available</div>
      <div class="stat-block-value green" id="s-bikes">â€”</div>
      <div class="stat-block-sub" id="s-ebikes">â€” e-bikes</div>
      <div class="stat-block-bar"></div>
    </div>
    <div class="stat-block">
      <div class="stat-block-label">Docks Open</div>
      <div class="stat-block-value" id="s-docks">â€”</div>
      <div class="stat-block-sub">For returns</div>
      <div class="stat-block-bar"></div>
    </div>
    <div class="stat-block">
      <div class="stat-block-label">Running Low</div>
      <div class="stat-block-value red" id="s-low">â€”</div>
      <div class="stat-block-sub">Stations with â‰¤2 bikes</div>
      <div class="stat-block-bar"></div>
    </div>
    <div class="stat-block">
      <div class="stat-block-label">Trips Last Hour</div>
      <div class="stat-block-value" id="s-trips-1h" style="color:var(--amber)">â€”</div>
      <div class="stat-block-sub" id="s-trips-1h-sub">Loadingâ€¦</div>
      <div class="stat-block-bar"></div>
    </div>
    <div class="stat-block">
      <div class="stat-block-label">Trips This Window</div>
      <div class="stat-block-value" id="s-trips-2h" style="color:var(--amber)">â€”</div>
      <div class="stat-block-sub" id="s-trips-2h-sub">From Supabase</div>
      <div class="stat-block-bar"></div>
    </div>
  </div>

  <!-- Recent Activity Panel -->
  <div class="panel" style="margin-bottom:20px">
    <div class="panel-head">
      <span class="panel-head-title">Recent Activity</span>
      <div style="display:flex;align-items:center;gap:8px">
        <button class="window-btn active" id="win-2h"  onclick="setWindow('2h')"  style="font-family:var(--font-mono);font-size:11px;padding:3px 10px;border-radius:2px;cursor:pointer;border:1px solid var(--rule);background:var(--accent);color:#fff;transition:all .15s">2h</button>
        <button class="window-btn"        id="win-6h"  onclick="setWindow('6h')"  style="font-family:var(--font-mono);font-size:11px;padding:3px 10px;border-radius:2px;cursor:pointer;border:1px solid var(--rule);background:none;color:var(--muted);transition:all .15s">6h</button>
        <button class="window-btn"        id="win-24h" onclick="setWindow('24h')" style="font-family:var(--font-mono);font-size:11px;padding:3px 10px;border-radius:2px;cursor:pointer;border:1px solid var(--rule);background:none;color:var(--muted);transition:all .15s">24h</button>
        <span class="panel-head-meta" id="activity-meta">Loadingâ€¦</span>
      </div>
    </div>
    <div id="activity-body">
      <div class="load-state"><div class="spinner"></div>Fetching recent tripsâ€¦</div>
    </div>
  </div>

  <!-- Main Grid -->
  <div class="main-grid">
    <!-- Station List -->
    <div class="panel">
      <div class="panel-head">
        <span class="panel-head-title">Stations</span>
        <span class="panel-head-meta" id="stationCount">Loadingâ€¦</span>
      </div>
      <div class="station-list" id="stationList">
        <div class="load-state"><div class="spinner"></div>Fetching live dataâ€¦</div>
      </div>
    </div>

    <!-- Right column -->
    <div class="right-col">
      <!-- Map -->
      <div id="map-wrap">
        <div id="map"></div>
        <div class="map-label">ğŸ“ Bay Ridge, Brooklyn</div>
        <div class="map-legend">
          <div class="legend-item"><div class="legend-dot" style="background:#00875a"></div>Plenty of bikes</div>
          <div class="legend-item"><div class="legend-dot" style="background:#0057b8"></div>Moderate</div>
          <div class="legend-item"><div class="legend-dot" style="background:#e8383b"></div>Running low</div>
          <div class="legend-item"><div class="legend-dot" style="background:transparent;border:2px dashed #c47c00"></div>Original station</div>
        </div>
      </div>

      <!-- Tide Chart -->
      <div class="tide-panel">
        <div class="panel-head">
          <span class="panel-head-title">The Commuter Tide</span>
          <span class="panel-head-meta">Based on Q3/Q4 2025 trip data</span>
        </div>
        <div class="tide-inner">
          <div class="tide-toggle">
            <button class="tide-btn active" onclick="showTide('weekday')" id="tide-weekday">Weekday</button>
            <button class="tide-btn" onclick="showTide('weekend')" id="tide-weekend">Weekend</button>
          </div>
          <div class="tide-note" id="tide-note">Outbound (leaving Bay Ridge) peaks at 7â€“8 AM. Inbound (returning) peaks at 5 PM.</div>
          <canvas id="tideChart" height="160"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     TAB 2 â€” HISTORICAL & IMPACT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="tab-content" id="content-hist">
<div class="hist-container">

  <!-- 01 â€” THE EXPANSION -->
  <div class="expansion-section">
    <div class="section-head">
      <span class="section-number">01</span>
      <span class="section-title">The Network Explosion</span>
      <span class="section-subtitle">May 2024 â€“ December 2025</span>
    </div>
    <p class="expansion-lead">
      Bay Ridge had <strong>5 Citi Bike stations</strong> for 16 months while the community debated their value.
      Then, in just 11 weeks between September and November 2025,
      <strong>44 more stations opened</strong> â€” one of the fastest neighborhood expansions in NYC Citi Bike history.
      The network went from a pilot to a real transportation layer almost overnight.
    </p>

    <!-- Timeline bars -->
    <div class="timeline-grid" id="timelineGrid"></div>
    <div class="timeline-legend">
      <div class="tl-legend-item"><div class="tl-dot" style="background:var(--accent)"></div>Original 5 stations</div>
      <div class="tl-legend-item"><div class="tl-dot" style="background:var(--amber)"></div>New stations (2025 expansion)</div>
      <div class="tl-legend-item" style="margin-left:auto;color:var(--muted)">Bar height = monthly trips</div>
    </div>

    <div class="expansion-stats">
      <div class="exp-stat">
        <div class="exp-stat-val">49</div>
        <div class="exp-stat-label">Total stations in Bay Ridge today, up from 5 in May 2024</div>
      </div>
      <div class="exp-stat amber">
        <div class="exp-stat-val">11</div>
        <div class="exp-stat-label">Weeks it took to open 44 new stations â€” Sep 11 to Nov 28, 2025</div>
      </div>
      <div class="exp-stat green">
        <div class="exp-stat-val">27K+</div>
        <div class="exp-stat-label">Trips taken in Bay Ridge during Q3/Q4 2025, the network's first real test</div>
      </div>
    </div>
  </div>

  <!-- 02 â€” PROOF OF CONCEPT -->
  <div class="proof-section">
    <div class="section-head">
      <span class="section-number">02</span>
      <span class="section-title">What the Original 5 Prove</span>
      <span class="section-subtitle">16 months of clean data</span>
    </div>

    <div class="poc-grid">
      <div class="poc-chart-wrap">
        <div class="poc-chart-title">Monthly trips per station</div>
        <div class="poc-chart-headline">Consistent growth through summer 2025</div>
        <div class="sparkline-list" id="sparklineList"></div>
      </div>

      <div class="rhythm-chart-wrap">
        <div class="poc-chart-title">Hourly rhythm â€” original 5 stations</div>
        <div class="poc-chart-headline">A morning exodus, an evening return</div>
        <div class="tide-note" style="margin-bottom:14px">The commuter pattern is clear. Bay Ridge rides out in the morning and back in the evening.</div>
        <canvas id="rhythmChart" height="200"></canvas>
      </div>
    </div>
  </div>

  <!-- 03 â€” THE SPACE ARGUMENT -->
  <div class="impact-section">
    <div class="section-head">
      <span class="section-number">03</span>
      <span class="section-title">The Space Argument</span>
      <span class="section-subtitle">Trips per parking spot</span>
    </div>

    <div class="impact-centerpiece">
      <div class="impact-kicker">Space Productivity â€” Original 5 Stations Â· May 2024 â€“ Dec 2025</div>
      <div class="impact-equation">
        <div class="impact-line">
          <div class="impact-num accent">~12</div>
          <div class="impact-desc"><strong>parking spots displaced</strong> by the original 5 stations<br>(avg 2.5 spots per station, standard NYC 8.5Ã—18 ft spaces)</div>
        </div>
        <div class="impact-line">
          <div class="impact-num">13,408</div>
          <div class="impact-desc"><strong>trips generated</strong> from those 12 spots over 20 months<br>median ride: 10.8 min Â· median distance: ~1.8 miles</div>
        </div>
        <div class="impact-line">
          <div class="impact-num accent">1.8</div>
          <div class="impact-desc"><strong>trips per parking spot, per day</strong><br>on a consistent, measured basis across 20 months</div>
        </div>
        <div class="impact-line">
          <div class="impact-num zero">0</div>
          <div class="impact-desc"><strong>trips generated by a parked car</strong><br>in the same space, over the same period</div>
        </div>
      </div>
      <div class="impact-footnote">
        Methodology: trip counts from Citi Bike public GBFS trip history data Â· original 5 stations installed May 2024 Â·
        parking spot displacement estimated at 2.5 spots/station based on standard NYC station footprints Â·
        economic value estimates use NYC DOT active transportation externality range of $1â€“$2/trip
      </div>
    </div>

    <div class="impact-secondary">
      <div class="impact-card">
        <div class="impact-card-icon">âš¡</div>
        <div class="impact-card-val">67%</div>
        <div class="impact-card-label">of Bay Ridge Citi Bike trips use e-bikes â€” well above the NYC average of ~50%, consistent with the neighborhood's hilly terrain</div>
      </div>
      <div class="impact-card">
        <div class="impact-card-icon">ğŸªª</div>
        <div class="impact-card-val">70.5%</div>
        <div class="impact-card-label">of riders are Citi Bike members â€” not tourists or casual users. This is real, local, committed transportation.</div>
      </div>
      <div class="impact-card">
        <div class="impact-card-icon">ğŸ“ˆ</div>
        <div class="impact-card-val">~$27K</div>
        <div class="impact-card-label">estimated economic value generated by the original 5 stations (at $2/trip). Full 49-station network projects to $220K+ annually at steady state.</div>
      </div>
    </div>
  </div>

  <!-- 04 â€” WHERE WE GO -->
  <div class="dest-section">
    <div class="section-head">
      <span class="section-number">04</span>
      <span class="section-title">Where Bay Ridge Rides</span>
      <span class="section-subtitle">Q3/Q4 2025 Â· top origins &amp; destinations</span>
    </div>
    <p class="expansion-lead" style="margin-bottom:20px">
      The destination data tells a clear story: Bay Ridge rides <strong>locally</strong>.
      Top trips head toward the waterfront, the Shore Pkwy Greenway, and the immediate surrounding streets â€”
      not toward Manhattan or distant neighborhoods. This is utility cycling within the community.
    </p>
    <div class="dest-grid">
      <div>
        <div class="panel-head" style="background:var(--surface);border:1px solid var(--rule);border-radius:4px 4px 0 0;margin-bottom:0">
          <span class="panel-head-title">Top Destinations (outbound trips)</span>
        </div>
        <div class="dest-list" id="destList" style="border-radius:0 0 4px 4px"></div>
      </div>
      <div>
        <div class="panel-head" style="background:var(--surface);border:1px solid var(--rule);border-radius:4px 4px 0 0;margin-bottom:0">
          <span class="panel-head-title">Top Origins (inbound trips)</span>
        </div>
        <div class="dest-list" id="origList" style="border-radius:0 0 4px 4px"></div>
      </div>
    </div>
  </div>

</div>
</div>

<!-- Detail Popup -->
<div class="detail-popup" id="detailPopup">
  <div class="detail-head">
    <div class="detail-name" id="detailName">â€”</div>
    <div class="detail-close" onclick="closeDetail()">âœ•</div>
  </div>
  <div class="detail-body">
    <div class="detail-row"><span>ğŸš² Bikes available</span><span class="detail-row-val" id="dBikes" style="color:var(--green)">â€”</span></div>
    <div class="detail-row"><span>âš¡ E-bikes</span><span class="detail-row-val" id="dEbikes" style="color:var(--accent)">â€”</span></div>
    <div class="detail-row"><span>ğŸ…¿ï¸ Docks open</span><span class="detail-row-val" id="dDocks" style="color:var(--ink2)">â€”</span></div>
    <div class="detail-row"><span>ğŸ“¦ Capacity</span><span class="detail-row-val" id="dCap" style="color:var(--muted)">â€”</span></div>
    <div class="detail-cap-track"><div class="detail-cap-fill" id="dCapFill" style="width:0%"></div></div>
    <div class="detail-cap-lbl"><span>Empty</span><span>Full</span></div>
  </div>
</div>

<!-- Scripts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SUPABASE CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SUPABASE_URL = 'https://vqichsthcvkdcnekfggr.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZxaWNoc3RoY3ZrZGNuZWtmZ2dyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE3MjE5NzQsImV4cCI6MjA4NzI5Nzk3NH0.DIPu7nZu53c9RzGBMfO4UyfnOGF-3wWk-Dq07fNnJa4';

async function sbGet(table, params) {
  const url = new URL(`${SUPABASE_URL}/rest/v1/${table}`);
  Object.entries(params).forEach(([k,v]) => url.searchParams.set(k, v));
  const r = await fetch(url, {
    headers: {
      'apikey': SUPABASE_ANON_KEY,
      'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
    }
  });
  if (!r.ok) throw new Error(`Supabase error: ${r.status}`);
  return r.json();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HISTORICAL DATA (from Q3/Q4 2025 analysis)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const HISTORICAL = {
  // Original 5 stations â€” monthly trips Jan-Dec 2025
  original5: {
    "4 Ave & Shore Road Dr":   [162,178,287,334,335,357,326,393,324,141,76,41],
    "3 Ave & Wakeman Pl":      [123,109,157,302,305,358,380,360,310,126,104,58],
    "Wakeman Pl & Ridge Blvd": [136,120,235,393,341,392,467,495,301,151,111,61],
    "67 St & Erik Pl":         [62,64,137,172,171,233,207,279,214,181,143,61],
    "5 Ave & 67 St":           [110,143,192,220,271,304,338,359,339,163,134,62],
  },
  months12: ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],

  // Hourly outbound/inbound ratios from prediction model
  hourly: {
    weekday: {
      hours:    [5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22],
      outbound: [49,47,50,43,41,46,42,37,38,32,33,35,35,30,28,27,30,27],
      inbound:  [22,23,27,26,31,28,27,27,31,32,35,42,48,40,42,44,40,43],
      internal: [29,31,23,31,28,26,32,35,31,36,32,29,26,30,30,29,30,30],
    },
    weekend: {
      hours:    [5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22],
      outbound: [38,35,36,30,28,34,36,32,30,28,30,28,27,26,24,23,24,22],
      inbound:  [28,30,32,35,38,34,30,32,35,36,36,38,40,42,46,48,44,46],
      internal: [34,35,32,35,34,32,34,36,35,36,34,34,33,32,30,29,32,32],
    }
  },

  // Top destinations & origins (Q3/Q4 2025)
  destinations: [
    {name:"59 St & 4 Ave",count:774},
    {name:"Shore Pkwy Greenway & Bay Ridge Ave",count:374},
    {name:"58 St & Pier 4",count:329},
    {name:"62 St & 4 Ave",count:235},
    {name:"50 St & 7 Ave",count:227},
    {name:"53 St & 4 Ave",count:226},
    {name:"56 St & 2 Ave",count:204},
    {name:"48 St & 5 Ave",count:181},
    {name:"36 St & 4 Ave",count:170},
    {name:"45 St & 4 Ave",count:159},
  ],
  origins: [
    {name:"59 St & 4 Ave",count:590},
    {name:"62 St & 4 Ave",count:381},
    {name:"58 St & Pier 4",count:366},
    {name:"Shore Pkwy Greenway & Bay Ridge Ave",count:335},
    {name:"7 Ave & 62 St",count:219},
    {name:"56 St & 2 Ave",count:215},
    {name:"53 St & 4 Ave",count:185},
    {name:"36 St & 4 Ave",count:183},
    {name:"50 St & 7 Ave",count:181},
    {name:"41 St & 4 Ave",count:176},
  ],

  // Timeline data â€” stations per month + trips (original vs new)
  timeline: [
    {m:"Sep'24",orig:593,new:0,label:"Sep"},
    {m:"Oct'24",orig:614,new:0,label:"Oct"},
    {m:"Nov'24",orig:650,new:0,label:"Nov"},
    {m:"Dec'24",orig:400,new:0,label:"Dec"},
    {m:"Jan'25",orig:593,new:0,label:"Jan"},
    {m:"Feb'25",orig:614,new:0,label:"Feb"},
    {m:"Mar'25",orig:1008,new:0,label:"Mar"},
    {m:"Apr'25",orig:1421,new:0,label:"Apr"},
    {m:"May'25",orig:1423,new:0,label:"May"},
    {m:"Jun'25",orig:1644,new:0,label:"Jun"},
    {m:"Jul'25",orig:1718,new:0,label:"Jul"},
    {m:"Aug'25",orig:1886,new:0,label:"Aug"},
    {m:"Sep'25",orig:1488,new:432,label:"Sep"},
    {m:"Oct'25",orig:762,new:5389,label:"Oct"},
    {m:"Nov'25",orig:568,new:5917,label:"Nov"},
    {m:"Dec'25",orig:283,new:4269,label:"Dec"},
  ],
};

const ORIGINAL_STATIONS = new Set([
  "4 Ave & Shore Road Dr","3 Ave & Wakeman Pl",
  "Wakeman Pl & Ridge Blvd","67 St & Erik Pl","5 Ave & 67 St"
]);

// Bay Ridge polygon
const BAY_RIDGE_POLYGON = [
  [40.642136,-74.028204],[40.642574,-74.033397],[40.639062,-74.037645],
  [40.625731,-74.042459],[40.615543,-74.041988],[40.609104,-74.038589],
  [40.608351,-74.035143],[40.610179,-74.03028],[40.617274,-74.024333],
  [40.622865,-74.019092],[40.633146,-74.014655],[40.636048,-74.014372],
  [40.642136,-74.028204],
];

function inBayRidge(lat,lon){
  const poly=BAY_RIDGE_POLYGON,n=poly.length;
  let inside=false,j=n-1;
  for(let i=0;i<n;i++){
    const[li,oi]=poly[i],[lj,oj]=poly[j];
    if((oi>lon)!==(oj>lon)&&lat<(lj-li)*(lon-oi)/(oj-oi)+li)inside=!inside;
    j=i;
  }
  return inside;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SUPABASE REAL-TIME ACTIVITY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let currentWindow = '2h';

function setWindow(w) {
  currentWindow = w;
  document.querySelectorAll('.window-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('win-' + w).classList.add('active');
  renderActivityWindow(window._tripCache || [], w);
}

function renderActivityWindow(trips, w) {
  const now = new Date();
  const cutoffs = { '2h': 2, '6h': 6, '24h': 24 };
  const hours = cutoffs[w];
  const cutoff = new Date(now - hours * 60 * 60 * 1000);
  const oneHourAgo = new Date(now - 60 * 60 * 1000);

  const filtered = trips.filter(t => new Date(t.detected_at) >= cutoff);
  const lastHour = trips.filter(t => new Date(t.detected_at) >= oneHourAgo);

  const dep1h = lastHour.reduce((s,t) => s+(t.trips_departed||0), 0);
  const arr1h = lastHour.reduce((s,t) => s+(t.trips_arrived||0), 0);
  const depW  = filtered.reduce((s,t) => s+(t.trips_departed||0), 0);
  const arrW  = filtered.reduce((s,t) => s+(t.trips_arrived||0), 0);

  document.getElementById('s-trips-1h').textContent = dep1h + arr1h;
  document.getElementById('s-trips-1h-sub').textContent = `${dep1h} out Â· ${arr1h} in`;
  document.getElementById('s-trips-2h').textContent = depW + arrW;
  document.getElementById('s-trips-2h-sub').textContent = `${depW} out Â· ${arrW} in Â· last ${w}`;

  if (!filtered.length) {
    document.getElementById('activity-body').innerHTML =
      `<div class="activity-empty">No trip activity in the last ${w}.</div>`;
    return;
  }

  const rate = dep1h + arr1h;
  const healthLabel = rate > 30 ? 'BUSY' : rate > 10 ? 'ACTIVE' : 'QUIET';
  const healthClass = rate > 30 ? 'busy'  : rate > 10 ? 'moderate' : 'healthy';

  const byStation = {};
  filtered.forEach(t => {
    if (!byStation[t.station_name]) byStation[t.station_name] = {dep:0, arr:0};
    byStation[t.station_name].dep += t.trips_departed||0;
    byStation[t.station_name].arr += t.trips_arrived||0;
  });

  const topDep = Object.entries(byStation)
    .filter(([,v]) => v.dep > 0)
    .sort((a,b) => b[1].dep - a[1].dep).slice(0, 8);
  const topArr = Object.entries(byStation)
    .filter(([,v]) => v.arr > 0)
    .sort((a,b) => b[1].arr - a[1].arr).slice(0, 8);

  const depHTML = topDep.length ? topDep.map(([name,v]) => `
    <div class="activity-item">
      <span class="activity-icon">ğŸš²</span>
      <span class="activity-station">${name}</span>
      <span class="activity-count dep">-${v.dep}</span>
    </div>`).join('') : '<div class="activity-empty">No departures in this window</div>';

  const arrHTML = topArr.length ? topArr.map(([name,v]) => `
    <div class="activity-item">
      <span class="activity-icon">ğŸ…¿ï¸</span>
      <span class="activity-station">${name}</span>
      <span class="activity-count arr">+${v.arr}</span>
    </div>`).join('') : '<div class="activity-empty">No arrivals in this window</div>';

  const lastTime = new Date(trips[0].detected_at)
    .toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});

  document.getElementById('activity-body').innerHTML = `
    <div class="activity-grid">
      <div class="activity-col">
        <div class="activity-col-title">Top Departures Â· last ${w}</div>
        ${depHTML}
      </div>
      <div class="activity-col">
        <div class="activity-col-title">Top Arrivals Â· last ${w}</div>
        ${arrHTML}
      </div>
    </div>
    <div class="network-health">
      <span class="health-badge ${healthClass}">${healthLabel}</span>
      <span>${depW} departures Â· ${arrW} arrivals in the last ${w}</span>
      <span style="margin-left:auto;font-family:var(--font-mono);font-size:11px;color:var(--muted)">
        via Supabase Â· last poll: ${lastTime}
      </span>
    </div>`;

  document.getElementById('activity-meta').textContent = `Last trip data: ${lastTime}`;
}

async function fetchRecentActivity() {
  try {
    const twentyFourHoursAgo = new Date(Date.now() - 24*60*60*1000).toISOString();

    const trips = await sbGet('inferred_trips', {
      'select':       'detected_at,station_name,trips_departed,trips_arrived',
      'detected_at':  `gte.${twentyFourHoursAgo}`,
      'is_rebalance': 'eq.false',
      'order':        'detected_at.desc',
      'limit':        '1000'
    });

    if (!trips.length) {
      document.getElementById('activity-body').innerHTML =
        '<div class="activity-empty">No trip activity recorded yet â€” check back after a few more polling cycles.</div>';
      document.getElementById('s-trips-1h').textContent = '0';
      document.getElementById('s-trips-1h-sub').textContent = 'No data yet';
      document.getElementById('s-trips-2h').textContent = '0';
      document.getElementById('s-trips-2h-sub').textContent = 'No data yet';
      return;
    }

    // Cache for window switching without re-fetching
    window._tripCache = trips;
    renderActivityWindow(trips, currentWindow);

  } catch(e) {
    console.error('Supabase fetch failed:', e);
    document.getElementById('activity-body').innerHTML =
      `<div class="activity-empty">Could not load activity data: ${e.message}</div>`;
    document.getElementById('s-trips-1h').textContent = '?';
    document.getElementById('s-trips-2h').textContent = '?';
  }
}
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LIVE DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const INFO_URL   = 'https://gbfs.citibikenyc.com/gbfs/en/station_information.json';
const STATUS_URL = 'https://gbfs.citibikenyc.com/gbfs/en/station_status.json';

let stations=[], selectedId=null, map=null, markers={};

window.addEventListener('load',()=>{
  initMap();
  fetchLiveData();
  fetchRecentActivity();
  setInterval(fetchLiveData, 120000);
  setInterval(fetchRecentActivity, 600000); // every 10 min
  buildHistoricalTab();
  initTideChart();
  initRhythmChart();
});

async function fetchLiveData(){
  try{
    const[iR,sR]=await Promise.all([fetch(INFO_URL),fetch(STATUS_URL)]);
    const iD=await iR.json(), sD=await sR.json();
    const sm={};sD.data.stations.forEach(s=>sm[s.station_id]=s);
    const br=iD.data.stations.filter(s=>inBayRidge(s.lat,s.lon));
    if(!br.length){renderError('No stations found in Bay Ridge.');return;}
    stations=br.map(info=>{
      const st=sm[info.station_id]||{};
      return{...info,
        num_bikes_available:st.num_bikes_available||0,
        num_ebikes_available:st.num_ebikes_available||0,
        num_docks_available:st.num_docks_available||0,
        is_installed:st.is_installed||0,
        is_renting:st.is_renting||0,
      };
    }).sort((a,b)=>b.num_bikes_available-a.num_bikes_available);
    updateSummary();renderStationList();updateMarkers();
    document.getElementById('lastUpdated').textContent=
      'Updated '+new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
  }catch(e){
    console.error(e);
    renderError('Could not load live data. Check your connection or run via local server.');
  }
}

function renderError(msg){
  document.getElementById('stationList').innerHTML=
    `<div class="load-state" style="color:#e8383b">âš  ${msg}</div>`;
}

function updateSummary(){
  const bikes=stations.reduce((s,x)=>s+x.num_bikes_available,0);
  const ebikes=stations.reduce((s,x)=>s+x.num_ebikes_available,0);
  const docks=stations.reduce((s,x)=>s+x.num_docks_available,0);
  const low=stations.filter(x=>x.num_bikes_available<=2).length;
  document.getElementById('s-stations').textContent=stations.length;
  document.getElementById('s-bikes').textContent=bikes;
  document.getElementById('s-ebikes').textContent=`${ebikes} e-bikes`;
  document.getElementById('s-docks').textContent=docks;
  document.getElementById('s-low').textContent=low;
  document.getElementById('stationCount').textContent=`${stations.length} stations`;
}

function renderStationList(){
  const list=document.getElementById('stationList');
  if(!stations.length){list.innerHTML='<div class="load-state">No stations found.</div>';return;}
  list.innerHTML=stations.map(s=>{
    const cap=s.capacity||(s.num_bikes_available+s.num_docks_available)||1;
    const bp=Math.round(s.num_bikes_available/cap*100);
    const dp=Math.round(s.num_docks_available/cap*100);
    const low=s.num_bikes_available<=2;
    const online=s.is_installed&&s.is_renting;
    const isOrig=ORIGINAL_STATIONS.has(s.name);
    return`<div class="station-item${selectedId===s.station_id?' selected':''}" onclick="selectStation('${s.station_id}')" id="si-${s.station_id}">
      <div class="station-item-name">${s.name}${isOrig?'<span class="badge original">ORIGINAL</span>':'<span class="badge new">NEW \'25</span>'}</div>
      <div class="station-bars">
        <div class="bar-grp">
          <div class="bar-lbl"><span>ğŸš² Bikes</span><span>${s.num_bikes_available}</span></div>
          <div class="bar-track"><div class="bar-fill bikes${low?' low':''}" style="width:${bp}%"></div></div>
        </div>
        <div class="bar-grp">
          <div class="bar-lbl"><span>ğŸ…¿ï¸ Docks</span><span>${s.num_docks_available}</span></div>
          <div class="bar-track"><div class="bar-fill docks" style="width:${dp}%"></div></div>
        </div>
      </div>
      <div class="station-item-meta"><span class="dot ${online?'on':'off'}"></span>${online?'Online':'Offline'} Â· Cap ${cap}${s.num_ebikes_available?` Â· âš¡${s.num_ebikes_available}`:''}</div>
    </div>`;
  }).join('');
}

function selectStation(id){
  selectedId=id;
  const s=stations.find(x=>x.station_id===id);if(!s)return;
  document.querySelectorAll('.station-item').forEach(e=>e.classList.remove('selected'));
  const el=document.getElementById('si-'+id);
  if(el){el.classList.add('selected');el.scrollIntoView({behavior:'smooth',block:'nearest'});}
  if(map)map.flyTo([s.lat,s.lon],16,{duration:.7});
  const cap=s.capacity||(s.num_bikes_available+s.num_docks_available)||1;
  document.getElementById('detailName').textContent=s.name;
  document.getElementById('dBikes').textContent=s.num_bikes_available;
  document.getElementById('dEbikes').textContent=s.num_ebikes_available;
  document.getElementById('dDocks').textContent=s.num_docks_available;
  document.getElementById('dCap').textContent=cap;
  document.getElementById('dCapFill').style.width=Math.round(s.num_bikes_available/cap*100)+'%';
  document.getElementById('detailPopup').classList.add('show');
}
function closeDetail(){
  document.getElementById('detailPopup').classList.remove('show');
  selectedId=null;
  document.querySelectorAll('.station-item').forEach(e=>e.classList.remove('selected'));
}

// â”€â”€ MAP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initMap(){
  map=L.map('map',{center:[40.625,-74.028],zoom:14,zoomControl:true,attributionControl:false});
  L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',{maxZoom:19}).addTo(map);
  // Draw neighborhood boundary
  L.polygon(BAY_RIDGE_POLYGON,{color:'#0057b8',weight:2,fillColor:'#0057b8',fillOpacity:.05,dashArray:'6,4'}).addTo(map);
}

function updateMarkers(){
  Object.values(markers).forEach(m=>m.remove());markers={};
  stations.forEach(s=>{
    const pct=s.num_bikes_available/Math.max(s.capacity||1,1);
    const col=s.num_bikes_available<=2?'#e8383b':pct>=.5?'#00875a':'#0057b8';
    const isOrig=ORIGINAL_STATIONS.has(s.name);
    const icon=L.divIcon({
      html:`<div style="width:28px;height:28px;border-radius:50%;background:${col};border:${isOrig?'3px dashed #c47c00':'2px solid rgba(255,255,255,.6)'};display:flex;align-items:center;justify-content:center;font-family:IBM Plex Mono,monospace;font-size:10px;font-weight:700;color:#fff;box-shadow:0 2px 6px rgba(0,0,0,.25);cursor:pointer">${s.num_bikes_available}</div>`,
      className:'',iconSize:[28,28],iconAnchor:[14,14]
    });
    const m=L.marker([s.lat,s.lon],{icon}).addTo(map).on('click',()=>selectStation(s.station_id));
    m.bindTooltip(`<b>${s.name}</b><br>ğŸš² ${s.num_bikes_available} Â· ğŸ…¿ï¸ ${s.num_docks_available}`,{className:'br-tooltip',direction:'top'});
    markers[s.station_id]=m;
  });
}

// â”€â”€ TIDE CHART â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let tideChart=null, currentTide='weekday';

function initTideChart(){
  const ctx=document.getElementById('tideChart').getContext('2d');
  tideChart=new Chart(ctx,{
    type:'line',data:{labels:[],datasets:[]},
    options:{
      responsive:true,
      interaction:{mode:'index',intersect:false},
      plugins:{
        legend:{labels:{color:'#8b92a8',font:{family:'IBM Plex Mono',size:10}}},
        tooltip:{backgroundColor:'#fff',borderColor:'#dde1ea',borderWidth:1,titleColor:'#0f1117',bodyColor:'#3a3f52',titleFont:{family:'IBM Plex Mono'}}
      },
      scales:{
        x:{ticks:{color:'#8b92a8',font:{family:'IBM Plex Mono',size:10}},grid:{color:'#f0f1f5'}},
        y:{ticks:{color:'#8b92a8',font:{family:'IBM Plex Mono',size:10},callback:v=>v+'%'},grid:{color:'#f0f1f5'},min:0,max:60}
      }
    }
  });
  showTide('weekday');
}

function showTide(mode){
  currentTide=mode;
  document.querySelectorAll('.tide-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('tide-'+mode).classList.add('active');
  const d=HISTORICAL.hourly[mode];
  const labels=d.hours.map(h=>h+':00');
  tideChart.data.labels=labels;
  tideChart.data.datasets=[
    {label:'Outbound %',data:d.outbound,borderColor:'#e8383b',backgroundColor:'rgba(232,56,59,.06)',fill:true,tension:.4,pointRadius:3,pointBackgroundColor:'#e8383b'},
    {label:'Inbound %',data:d.inbound,borderColor:'#0057b8',backgroundColor:'rgba(0,87,184,.06)',fill:true,tension:.4,pointRadius:3,pointBackgroundColor:'#0057b8'},
    {label:'Internal %',data:d.internal,borderColor:'#00875a',backgroundColor:'rgba(0,135,90,.05)',fill:true,tension:.4,pointRadius:3,pointBackgroundColor:'#00875a'},
  ];
  tideChart.update();
  document.getElementById('tide-note').textContent=mode==='weekday'
    ?'Outbound peaks at 7â€“8 AM, inbound peaks at 5 PM â€” a clear commuter signature. Internal trips stay remarkably flat all day, a steady background hum of local rides.'
    :'Weekends show a flatter pattern across all three types. Internal trips run slightly higher â€” more people riding within the neighborhood for leisure and errands.';
}

// â”€â”€ HISTORICAL TAB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildHistoricalTab(){
  buildTimeline();
  buildSparklines();
  buildDestLists();
}

function buildTimeline(){
  const grid=document.getElementById('timelineGrid');
  const data=HISTORICAL.timeline;
  const maxVal=Math.max(...data.map(d=>d.orig+d.new));
  const maxH=120;
  grid.innerHTML=data.map(d=>{
    const origH=Math.max(4,Math.round(d.orig/maxVal*maxH));
    const newH=d.new?Math.max(4,Math.round(d.new/maxVal*maxH)):0;
    return`<div class="timeline-col">
      ${newH?`<div class="timeline-bar new" style="height:${newH}px" title="${d.m} new stations: ${d.new} trips"></div>`:''}
      <div class="timeline-bar original" style="height:${origH}px" title="${d.m} original stations: ${d.orig} trips"></div>
      <div class="timeline-month-label">${d.label}</div>
    </div>`;
  }).join('');
}

function buildSparklines(){
  const container=document.getElementById('sparklineList');
  const months=HISTORICAL.months12;
  const entries=Object.entries(HISTORICAL.original5);
  const globalMax=Math.max(...entries.flatMap(([,v])=>v));
  container.innerHTML=entries.map(([name,vals])=>{
    const total=vals.reduce((a,b)=>a+b,0);
    const bars=vals.map((v,i)=>{
      const h=Math.max(4,Math.round(v/globalMax*48));
      return`<div class="sparkline-bar" style="height:${h}px" title="${months[i]}: ${v} trips"></div>`;
    }).join('');
    return`<div class="sparkline-row">
      <div class="sparkline-name">${name}</div>
      <div class="sparkline-bars">${bars}</div>
      <div class="sparkline-total">${total.toLocaleString()}</div>
    </div>`;
  }).join('');
}

let rhythmChart=null;
function initRhythmChart(){
  const ctx=document.getElementById('rhythmChart').getContext('2d');
  const d=HISTORICAL.hourly.weekday;
  rhythmChart=new Chart(ctx,{
    type:'bar',
    data:{
      labels:d.hours.map(h=>h+':00'),
      datasets:[
        {label:'Outbound',data:d.outbound,backgroundColor:'rgba(232,56,59,.7)',borderRadius:2},
        {label:'Inbound',data:d.inbound,backgroundColor:'rgba(0,87,184,.7)',borderRadius:2},
      ]
    },
    options:{
      responsive:true,
      plugins:{
        legend:{labels:{color:'#8b92a8',font:{family:'IBM Plex Mono',size:10}}},
        tooltip:{backgroundColor:'#fff',borderColor:'#dde1ea',borderWidth:1,titleColor:'#0f1117',bodyColor:'#3a3f52',titleFont:{family:'IBM Plex Mono'}}
      },
      scales:{
        x:{ticks:{color:'#8b92a8',font:{family:'IBM Plex Mono',size:9}},grid:{display:false}},
        y:{ticks:{color:'#8b92a8',font:{family:'IBM Plex Mono',size:10},callback:v=>v+'%'},grid:{color:'#f0f1f5'}}
      }
    }
  });
}

function buildDestLists(){
  const maxD=HISTORICAL.destinations[0].count;
  const maxO=HISTORICAL.origins[0].count;
  document.getElementById('destList').innerHTML=HISTORICAL.destinations.map((d,i)=>`
    <div class="dest-item">
      <span class="dest-rank">${i+1}</span>
      <span class="dest-name">${d.name}</span>
      <span class="dest-count">${d.count.toLocaleString()}</span>
      <div class="dest-bar-wrap"><div class="dest-bar" style="width:${Math.round(d.count/maxD*100)}%"></div></div>
    </div>`).join('');
  document.getElementById('origList').innerHTML=HISTORICAL.origins.map((d,i)=>`
    <div class="dest-item">
      <span class="dest-rank">${i+1}</span>
      <span class="dest-name">${d.name}</span>
      <span class="dest-count">${d.count.toLocaleString()}</span>
      <div class="dest-bar-wrap"><div class="dest-bar" style="width:${Math.round(d.count/maxO*100)}%"></div></div>
    </div>`).join('');
}

function switchTab(tab){
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
  document.getElementById('tab-'+tab).classList.add('active');
  document.getElementById('content-'+tab).classList.add('active');
  if(tab==='live'&&map)setTimeout(()=>map.invalidateSize(),100);
}
</script>

<style>
.window-btn.active{background:var(--accent)!important;color:#fff!important;border-color:var(--accent)!important}
.br-tooltip{background:#fff!important;border:1px solid #dde1ea!important;color:#0f1117!important;font-family:'IBM Plex Sans',sans-serif;font-size:12px;border-radius:3px;box-shadow:0 2px 8px rgba(0,0,0,.1)}
.br-tooltip::before{border-top-color:#dde1ea!important}
</style>
</body>
</html>
